name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version type to bump packages to'
        required: true
        type: choice
        default: ''
        options:
          - path
          - minor
          - major

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-release
  cancel-in-progress: true

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [16]

    steps:
      - uses: actions/checkout@v3
        with:
          # We need to fetch all branches and commits so that Nx affected has a base to compare against.
          fetch-depth: 0

      - name: Derive appropriate SHAs for base and head for `nx affected` commands
        id: set-shas
        uses: nrwl/nx-set-shas@v3
        with:
          last-successful-event: release

      - name: Setup
        uses: ./.github/actions/setup
        with:
          node-version: ${{ matrix.node-version }}
          github-token: ${{ secrets.GH_PAT }}

      - name: Test
        uses: ./.github/actions/test
        with:
          from: ${{ steps.set-shas.outputs.base }}

  release:
    runs-on: ubuntu-latest

    if: github.ref == 'refs/heads/main'

    needs: [test]

    steps:
      - uses: actions/checkout@v3

      - name: Setup
        uses: ./.github/actions/setup
        with:
          github-token: ${{ secrets.GH_PAT }}

      - name: Derive appropriate SHAs for base and head for `nx affected` commands
        id: set-shas
        uses: nrwl/nx-set-shas@v3
        with:
          last-successful-event: release

      - name: Release
        uses: ./.github/actions/release
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          npm-token: ${{ secrets.NPM_TOKEN }}
          version: ${{ inputs.version }}
          last-release: ${{ steps.set-shas.outputs.base }}
